<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">                                               <!-- defines the encoding of the website, utf-8 is the standard -->
    <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- viewport settings related to mobile responsiveness -->
    <!--
    The above 2 meta tags *must* come first in the <head>
    to consistently ensure proper document rendering.
    Any other head element should come *after* these tags.
    -->
    <meta width=device-width> <!-- use the physical width of the device (great for mobile!) -->
    <meta initial-scale=1>    <!-- the initial zoom, 1 means no zoom -->

    <title>V2.2 (better on phone?)</title>
    <meta name="application-name" content="HOUR 248"> <!-- Name of web application (only should be used if the website is used as an app) -->
    <meta name="theme-color" content="#000">

<!-- ****************************************************************************************************************************** -->
<!-- CSS -->
    <style>

        html, body { 
            padding: 0;
            margin: 0;
            overflow: hidden; /* remove scrollbars, this is needed to display this page in an iframe without scrollbars */
        }

    </style>
</head>

<!-- ****************************************************************************************************************************** -->
<!-- HTML -->
<body>
<canvas id="canvas">
    <!-- error message -->
    Your browser does not support the HTML5 canvas tag.
</canvas>

<!-- debug info -->
<div id='debuginfo'>-</div>

<script>
/***********************************************************************************************************************************/
// CANVAS

    // init 2D canvas
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    var scaleFactor = window.devicePixelRatio; // to have better qualituy images on mobile phones

    // resize the canvas when needed
    resizeCanvas(); // initial resize, setting the first size
    window.addEventListener("resize", resizeCanvas); // Add event listener for window resize

    function resizeCanvas() {

        // resize the canvas
        if (window.innerWidth < window.innerHeight) {
            canvas.width = window.innerWidth * scaleFactor;
            canvas.height = window.innerWidth * scaleFactor;
        } else {
            canvas.width = window.innerHeight * scaleFactor;
            canvas.height = window.innerHeight * scaleFactor;
        }

        // animation settings
        var refreshRateInSeconds = 1;

        var numberOfBgs   = 2;
        var numberOfSky   = 11;
        var numberOfLines = 8;

        var prevBgImg    = 0;
        var prevSkyImg   = 0;
        var prevLinesImg = 0;

        // start with the 1st image, it will immidiatly changed based on the time anyway
        var imgBg    = 1;
        var imgSky   = 1;

        // generate a random lines image
        var imgLines = getRandomNumber(numberOfLines); // except the lines image needs to be a random one because it only changes when the minutes are dividable by the amount of time it takes to change
        var lastImgLinesChange = Date.now(); // keep track of when the last time was when we generated a new image, so we know when to generate a new one

        // signature layer settings
        var overlayImage = new Image();
            overlayImage.src = 'img/white on transparant.png';

            var overlayWidth = canvas.width * 0.12;                                           // width of image in %
            var overlayHeight = (overlayWidth / overlayImage.width) * overlayImage.height;  // Maintain aspect ratio
            var overlayX = canvas.width - overlayWidth - (canvas.width * 0.02);             // margin from the right edge in %
            var overlayY = canvas.height - overlayHeight - (canvas.height * 0.02);          // margin from the bottom edge in %


        // animation loop
        setInterval(draw, refreshRateInSeconds * 1000);

        // setInterval waits before executing its function, so call the function once when the page starts
        draw();
        function draw() {

            // get time
            var timeLocal = new Date();
            var timeEpoch = Date.now(); 

            /*********/
            /* BGS */// -> 1 per 30min (epoch time), mapped with modulo
            /*********/

            var epochMinutes = TimeEpochToMinutes(timeEpoch);
            imgBg = Math.floor(epochMinutes / 30) % numberOfBgs; // change modulo to 30 minutes
            imgBg++ // imgBg++ because the modulo remaps to a base zero and my images start from 0001.png

            /*******/
            /* SKY */// -> 1 per hour (local time), 24 images
            /*******/

            imgSky = timeLocal.getHours(); // timeLocal.getHours();

            /*********/
            /* LINES */// -> 1 per 1min, randomly
            /*********/

            var epochSeconds = TimeEpochToSeconds(timeEpoch);
            var lastImgLinesChangeSeconds = TimeEpochToSeconds(lastImgLinesChange);
            
            if( (epochSeconds-lastImgLinesChangeSeconds) >= 10) { // check if 1 min has passed since the last line image was changed
                imgLines = getRandomNumber(numberOfLines);
                lastImgLinesChange = timeEpoch;
                console.log('YES');
            }

            console.log('epochSeconds-lastImgLinesChangeSeconds:', epochSeconds-lastImgLinesChangeSeconds);

            /*********************************/
            /* only load images that changed */
            /*********************************/

            var redraw = false;

            if (imgBg != prevBgImg)       redraw = true;
            if (imgSky != prevSkyImg)     redraw = true;
            if (imgLines != prevLinesImg) redraw = true;
            prevBgImg = imgBg;
            prevSkyImg = imgSky;
            prevLinesImg = imgLines;

            /**************************/
            /* DRAW if images changed */
            /**************************/

            if (redraw) {

                // clear canvas
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

                // draw BG
                var imgBgObject = new Image();
                    imgBgObject.src = "img/bg/" + leadingZeros(imgBg, 4) + ".png";
                    imgBgObject.onload = function() {
                        ctx.drawImage(imgBgObject, 0, 0, canvas.width, canvas.height);

                        // draw SKY
                        var imgSkyObject = new Image();
                            imgSkyObject.src = "img/sky/" + leadingZeros(imgSky, 4) + ".png";
                            imgSkyObject.onload = function() {
                                ctx.drawImage(imgSkyObject, 0, 0, canvas.width, canvas.height);

                                // draw LINES
                                var imgLinesObject = new Image();
                                    imgLinesObject.src = "img/lines/" + leadingZeros(imgLines, 4) + ".png";
                                    imgLinesObject.onload = function() {
                                        ctx.drawImage(imgLinesObject, 0, 0, canvas.width, canvas.height);

                                    } // imgLinesObject.onload
                            } // imgSkyObject.onload
                    } // imgBgObject.onload

            } // if (redraw)

            /******************/
            /* DRAW signature */
            /******************/

            ctx.drawImage(overlayImage, overlayX, overlayY, overlayWidth, overlayHeight);

            // log
            if (redraw) {
                console.warn(" ")
                console.warn("Redraw:", redraw);
                console.warn("Bg (changes every 30min),", TimeEpochToHours(timeEpoch) + ":" + TimeEpochToMinutes(timeEpoch) + ":" + TimeEpochToSeconds(timeEpoch), "(epoch time): bg/" + imgBg + ".png");
                console.warn("Sky (changes every hour),", TimeLocalToReadable(timeLocal), "(local time): sky/" + imgSky + ".png");
                console.warn("Lines (changes every min),", TimeLocalToReadable(timeLocal), "(local time): lines/" + imgLines + ".png");
            } else {
                console.log(" ")
                console.log("Redraw:", redraw);
                console.log("Bg (changes every 30min),", TimeEpochToHours(timeEpoch) + ":" + TimeEpochToMinutes(timeEpoch) + ":" + TimeEpochToSeconds(timeEpoch), "(epoch time): bg/" + imgBg + ".png");
                console.log("Sky (changes every hour),", TimeLocalToReadable(timeLocal), "(local time): sky/" + imgSky + ".png");
                console.log("Lines (changes every min),", TimeLocalToReadable(timeLocal), "(local time): lines/" + imgLines + ".png");
            }
            
            document.getElementById('debuginfo').innerHTML = '<ul><li>Local time: ' +
            timeLocal + '</li><li>Universal  time: ' +
            TimeEpochToHours(timeEpoch) + ':' + TimeEpochToMinutes(timeEpoch) +
            ':' + TimeEpochToSeconds(timeEpoch) + '</li></ul>';
            
        } // function draw()
    } // function resizeCanvas()

//***********************************
// HELPER FUNCTION

function TimeLocalToReadable (t) { return t.toLocaleTimeString('en-GB'); }
function TimeEpochToHours(t)     { return leadingZeros(new Date(t).getUTCHours(),   2); }
function TimeEpochToMinutes(t)   { return leadingZeros(new Date(t).getUTCMinutes(), 2); }
function TimeEpochToSeconds(t)   { return leadingZeros(new Date(t).getUTCSeconds(), 2); }

function leadingZeros(num, amountOfZeros) {
// amountOfZeros: if you want 02, amountOfZeros is 2, if you want 0002, amountOfZeros is 4, ...
    num = num.toString();
    while (num.length < amountOfZeros) num = "0" + num;
    return num;
}

function getRandomNumber(max) {
// generates a random number between 1 and max
  return Math.floor(Math.random() * max) + 1;
}

/***********************************************************************************************************************************/
</script>
</body>
</html>